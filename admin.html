<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ceylonese TimeClock — Admin</title>

  <!-- Fonts & Supabase -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0f1115; --panel:#151a22; --ink:#e7ebf2; --muted:#94a3b8;
      --gold:#c9a227; --red:#ef4444; --green:#22c55e; --border:#1f2430;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--gold);text-decoration:none}
    .page{min-height:100svh;display:flex;flex-direction:column}
    .wrap{width:100%;max-width:1200px;margin:0 auto;padding:clamp(16px,3vw,24px)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:6px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .right{margin-left:auto}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 10px 28px rgba(0,0,0,.25)}
    input,button,select{font:inherit}
    input{width:100%;min-width:0;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0c0f14;color:var(--ink)}
    label{display:block;font-weight:600;margin:0 0 6px}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#0c0f14;color:#fff;cursor:pointer;font-weight:700;min-height:40px}
    button.primary{background:var(--gold);border-color:var(--gold);color:#111}
    button.ghost{background:transparent}
    button.approve{background:#103314;border-color:#103314}
    button.reject{background:#3a2020;border-color:#3a2020}
    button:disabled{opacity:.55;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-bottom:12px}
    .field{min-width:180px}
    .table-scroll{position:relative;width:100%;overflow-x:auto;overflow-y:auto;-webkit-overflow-scrolling:touch;max-height:60vh;border-radius:12px}
    table{width:100%;border-collapse:collapse;min-width:900px}
    th,td{padding:10px;border-bottom:1px solid #222b3a;vertical-align:middle}
    th{text-align:left;color:#cbd5e1;font-weight:700}
    thead th{position:sticky;top:0;background:var(--panel);z-index:2;box-shadow:0 2px 0 0 #222b3a}
    .status{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#d1d5db}
    .status.pending{background:#101521;color:#f8fafc}
    .status.approved{background:#0f2f19;color:#dcfce7;border-color:#1e4f2b}
    .status.rejected{background:#3a2020;color:#fee2e2;border-color:#5b2525}
    @media(max-width:760px){
      .row > *{flex:1 1 100%}
      .toolbar{align-items:stretch}
      .field{min-width:unset}
      table{min-width:760px}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="wrap">
      <header>
        <div class="row">
          <strong style="font-size:18px">Ceylonese — Admin</strong>
          <span class="pill">Attendance</span>
        </div>
        <div class="row" style="min-width:260px">
          <a href="./" class="ghost" style="padding:10px 12px;border:1px solid var(--border);border-radius:10px">← Staff</a>
          <span id="who" class="muted" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%"></span>
          <button id="btnSignOut" class="ghost">Sign out</button>
        </div>
      </header>
    </div>

    <main class="wrap">
      <!-- Create Staff -->
      <section class="card" style="margin-bottom:14px">
        <h3 style="margin:0 0 12px">Create Staff Member</h3>
        <div class="row">
          <div class="field" style="flex:1 1 240px; min-width:220px">
            <label>Full name</label>
            <input id="cs_fullname" type="text" placeholder="Jane Doe" />
          </div>
          <div class="field" style="flex:1 1 260px; min-width:240px">
            <label>Email</label>
            <input id="cs_email" type="email" placeholder="jane@company.com" />
          </div>
          <div class="field" style="min-width:140px">
            <label>&nbsp;</label>
            <label class="muted" style="display:flex;gap:8px;align-items:center">
              <input id="cs_is_admin" type="checkbox" /> Make admin
            </label>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div class="right" style="display:flex;gap:10px;align-items:center">
            <button id="cs_create" class="primary">Create Staff</button>
            <span id="cs_msg" class="muted"></span>
          </div>
        </div>
      </section>

      <!-- Filter + Table -->
      <section class="card">
        <div class="toolbar">
          <div class="field" style="flex:1 1 160px">
            <label>From</label>
            <input id="fromDate" type="date" />
          </div>
          <div class="field" style="flex:1 1 160px">
            <label>To</label>
            <input id="toDate" type="date" />
          </div>
          <div style="display:flex;gap:10px;align-items:flex-end">
            <button id="btnApply" class="primary">Apply</button>
            <button id="btnExport" class="ghost">Export CSV</button>
          </div>
          <span id="loadMsg" class="muted right"></span>
        </div>

        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>When</th>
                <th>User</th>
                <th>Clock In</th>
                <th>Clock Out</th>
                <th>Hours</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="adminBody">
              <tr><td colspan="7" class="muted">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== Supabase init (client) =====
    const SUPABASE_URL = "https://yunrapnjbzyqqzomcqoc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1bnJhcG5qYnp5cXF6b21jcW9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MjkyMTUsImV4cCI6MjA3MjEwNTIxNX0.E_qqD6scsCohrTDOrSZ_TfaLSslXSEb4p5t70UpDT24";
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const toISOStart = (dStr) => new Date(dStr + "T00:00:00").toISOString();
    const toISOEnd   = (dStr) => new Date(dStr + "T23:59:59.999").toISOString();

    async function getProfile(){
      const { data: { user } } = await supa.auth.getUser();
      if (!user) return { user:null, profile:null };
      const { data: profile } = await supa.from("profiles").select("*").eq("id", user.id).maybeSingle();
      return { user, profile };
    }
    const isAdmin = (p) => p?.is_admin === true || String(p?.role||"").toLowerCase() === "admin";

    // ===== Sign out (non-blocking) =====
    function nukeSupabaseStorage(){ try { Object.keys(localStorage).forEach(k=>{ if(k.startsWith("sb-")) localStorage.removeItem(k); }); sessionStorage.clear?.(); } catch(_){} }
    function tryGlobalSignOutNonBlocking(t=1200){ try{ const p=supa.auth.signOut({scope:"global"}); Promise.race([p,sleep(t)]).catch(()=>{});}catch(_){} }
    function hardReload(d=50){ setTimeout(()=>{ try{location.reload();return;}catch(e){} try{top.location.reload();return;}catch(e){} try{const b=location.href.split("#")[0];const s=b.includes("?")?"&":"?";location.href=`${b}${s}_r=${Date.now()}`;return;}catch(e){} try{history.go(0);}catch(e){} },d); }
    function signOutSafely(){ try{supa.auth.signOut({scope:"local"}).catch(()=>{});}catch(_){} nukeSupabaseStorage(); tryGlobalSignOutNonBlocking(); requestAnimationFrame(()=>hardReload()); }
    $("btnSignOut").onclick = () => { $("btnSignOut").disabled = true; signOutSafely(); };

    // ===== Shifts (from view) =====
    let CURRENT_SHIFTS = [];

    async function fetchShifts(fromISO, toISO){
      const { data, error } = await supa
        .from("shifts_view")
        .select("*")
        .gte("in_time", fromISO)
        .lte("out_time", toISO)
        .order("user_id", { ascending: true })
        .order("in_time", { ascending: true });
      if (error) { console.error("fetchShifts error:", error); throw error; }
      return data || [];
    }

    async function setApproval(shift, status){
      try{
        // Update the OUT row’s status
        const { error } = await supa
          .from("punches")
          .update({ status })
          .eq("id", shift.punch_out_id);
        if (error) throw error;

        shift.status = status;
        renderShifts();
      }catch(e){
        console.error(e);
        alert("Failed to update status (check RLS).");
      }
    }

    function renderShifts(){
      const body = $("adminBody");
      if (!CURRENT_SHIFTS.length){
        body.innerHTML = `<tr><td colspan="7" class="muted">No shifts in this range.</td></tr>`;
        return;
      }
      body.innerHTML = CURRENT_SHIFTS.map((s, i) => `
        <tr data-idx="${i}">
          <td>${new Date(s.in_time).toLocaleDateString()} <span class="muted">(${new Date(s.in_time).toLocaleDateString(undefined,{weekday:'short'})})</span></td>
          <td>${(s.full_name || s.email || s.user_id)}</td>
          <td>${new Date(s.in_time).toLocaleTimeString()}</td>
          <td>${new Date(s.out_time).toLocaleTimeString()}</td>
          <td>${Number(s.hours).toFixed(2)}</td>
          <td><span class="status ${s.status}">${(s.status||'pending').replace(/^./,c=>c.toUpperCase())}</span></td>
          <td>
            <div style="display:flex;gap:8px">
              <button class="approve" data-action="approve" ${s.status==='approved'?'disabled':''}>Approve</button>
              <button class="reject"  data-action="reject"  ${s.status==='rejected'?'disabled':''}>Reject</button>
            </div>
          </td>
        </tr>
        <tr><td colspan="7" class="muted">${s.note ? ('Note: ' + String(s.note).replace(/</g,'&lt;').replace(/>/g,'&gt;')) : ''}</td></tr>
      ").join("");
      body.onclick = async (e)=>{
        const btn = e.target.closest("button[data-action]"); if (!btn) return;
        const row = btn.closest("tr[data-idx]"); if (!row) return;
        const idx = +row.dataset.idx; const shift = CURRENT_SHIFTS[idx];
        const status = btn.dataset.action === 'approve' ? 'approved' : 'rejected';
        await setApproval(shift, status);
      };
    }

    function exportCSV(){
      if (!CURRENT_SHIFTS.length){ alert("Nothing to export"); return; }
      const header = ["Date","User","Clock In","Clock Out","Hours","Status","Note"];
      const csv = [header.join(",")].concat(
        CURRENT_SHIFTS.map(s => [
          new Date(s.in_time).toISOString(),
          `"${(s.full_name || s.email || s.user_id).replace(/"/g,'""')}"`,
          new Date(s.in_time).toLocaleTimeString(),
          new Date(s.out_time).toLocaleTimeString(),
          Number(s.hours).toFixed(2),
          (s.status || 'pending').toUpperCase(),
          `"${(s.note||"").replace(/"/g,'""')}"`
        ].join(","))
      ).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = "all-shifts.csv"; a.click();
      URL.revokeObjectURL(url);
    }

    // ===== Create Staff (uses your Netlify function, auto-confirm flow) =====
    (function wireCreateStaff(){
      const btn = $("cs_create"), msg = $("cs_msg");
      btn.onclick = async () => {
        const full_name = $("cs_fullname").value.trim();
        const email = $("cs_email").value.trim();
        const is_admin = $("cs_is_admin").checked;
        msg.textContent = "";
        if (!full_name || !email){ msg.textContent = "Full name and email are required."; return; }
        const { data: { session } } = await supa.auth.getSession();
        const accessToken = session?.access_token;
        if (!accessToken){ msg.textContent = "Not signed in."; return; }

        btn.disabled = true; msg.textContent = "Creating…";
        try{
          const res = await fetch('/.netlify/functions/create-staff', {
            method: 'POST',
            headers: { 'Content-Type':'application/json', 'Authorization': `Bearer ${accessToken}` },
            body: JSON.stringify({ email, full_name, role: is_admin?'admin':'staff', is_admin })
          });
          const j = await res.json().catch(()=> ({}));
          if (!res.ok){ msg.textContent = j.error || "Failed to create staff."; return; }
          const creds = `Email: ${email}\nTemp password: ${j.password}`;
          try { await navigator.clipboard.writeText(creds); } catch(_){}
          msg.textContent = "Staff created ✔  (temp password copied)";
          alert(`Staff created.\n\n${creds}\n\nShare securely with the staff member.`);
          $("cs_fullname").value = ""; $("cs_email").value = ""; $("cs_is_admin").checked = false;
        }catch(e){
          console.warn(e); msg.textContent = "Network error.";
        }finally{
          btn.disabled = false;
        }
      };
    })();

    // ===== Filters / boot =====
    function setDefaultDates(){
      const today = new Date(); today.setHours(0,0,0,0);
      const dTo = today.toISOString().slice(0,10);
      const from = new Date(today); from.setDate(from.getDate()-30);
      const dFrom = from.toISOString().slice(0,10);
      $("fromDate").value = dFrom; $("toDate").value = dTo;
    }

    async function loadRange(){
      const from = $("fromDate").value, to = $("toDate").value;
      if (!from || !to){ alert("Please select From and To dates"); return; }
      $("loadMsg").textContent = "Loading…";
      const fromISO = toISOStart(from), toISO = toISOEnd(to);
      try{
        CURRENT_SHIFTS = await fetchShifts(fromISO, toISO);
        renderShifts();
      }catch(e){
        console.error(e);
        $("adminBody").innerHTML = `<tr><td colspan="7" class="muted">Failed to load shifts.</td></tr>`;
      }finally{
        $("loadMsg").textContent = "";
      }
    }

    (async () => {
      const ctx = await getProfile();
      if (!ctx.user){ window.location.replace("./"); return; }
      if (!isAdmin(ctx.profile)){ alert("Admin access required"); window.location.replace("./"); return; }
      $("who").textContent = ctx.profile?.full_name || ctx.user.email || "Admin";
      setDefaultDates();
      $("btnApply").onclick = loadRange;
      $("btnExport").onclick = exportCSV;
      await loadRange();
      supa.auth.onAuthStateChange(async (_ev, session) => { if (!session) window.location.replace("./"); });
    })();
  </script>
</body>
</html>
