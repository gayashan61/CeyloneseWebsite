<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ceylonese TimeClock — Admin</title>

  <!--
  Run this once in Supabase SQL to enable approvals (optional but recommended):

  create table if not exists public.shift_approvals (
    id uuid primary key default gen_random_uuid(),
    user_id uuid not null,
    in_time timestamptz not null,
    out_time timestamptz not null,
    hours numeric not null,
    status text not null check (status in ('approved','rejected')),
    approved_by uuid not null,
    approved_at timestamptz not null default now(),
    note text
  );

  -- Speed up lookups & avoid duplicates (not required but ideal):
  create unique index if not exists ux_shift_approvals_key
    on public.shift_approvals (user_id, in_time, out_time);
  -->

  <!-- Fonts & Supabase -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0f1115; --panel:#151a22; --ink:#e7ebf2; --muted:#94a3b8;
      --gold:#c9a227; --red:#ef4444; --green:#22c55e; --border:#1f2430;
      --amber:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--gold);text-decoration:none}
    .page{min-height:100svh;display:flex;flex-direction:column}
    .wrap{width:100%;max-width:1200px;margin:0 auto;padding:clamp(16px,3vw,24px)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:6px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .right{margin-left:auto}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 10px 28px rgba(0,0,0,.25)}

    input,button,select{font:inherit}
    input{width:100%;min-width:0;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0c0f14;color:var(--ink)}
    label{display:block;font-weight:600;margin:0 0 6px}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#0c0f14;color:#fff;cursor:pointer;font-weight:700;min-height:40px}
    button.primary{background:var(--gold);border-color:var(--gold);color:#111}
    button.ghost{background:transparent}
    button.danger{background:transparent;border-color:#3a2020;color:#fecaca}
    button.approve{background:#103314;border-color:#103314}
    button.reject{background:#3a2020;border-color:#3a2020}
    button:disabled{opacity:.55;cursor:not-allowed}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin-bottom:12px}
    .field{min-width:180px}

    .banner{background:#2c2210;border:1px solid #3b2d12;color:#fef3c7;padding:10px 12px;border-radius:10px;margin:10px 0}

    .table-scroll{position:relative;width:100%;overflow-x:auto;overflow-y:auto;-webkit-overflow-scrolling:touch;max-height:60vh;border-radius:12px}
    .table-scroll::after{content:"Swipe to scroll →";position:absolute;right:8px;bottom:6px;font-size:12px;color:var(--muted);pointer-events:none;opacity:0}
    @media(max-width:760px){.table-scroll::after{opacity:.9}}

    table{width:100%;border-collapse:collapse;min-width:900px}
    th,td{padding:10px;border-bottom:1px solid #222b3a;vertical-align:middle}
    th{text-align:left;color:#cbd5e1;font-weight:700}
    thead th{position:sticky;top:0;background:var(--panel);z-index:2;box-shadow:0 2px 0 0 #222b3a}

    .status{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#d1d5db}
    .status.pending{background:#101521;color:#f8fafc}
    .status.approved{background:#0f2f19;color:#dcfce7;border-color:#1e4f2b}
    .status.rejected{background:#3a2020;color:#fee2e2;border-color:#5b2525}

    .controls{display:flex;gap:8px}
    .fit{white-space:nowrap}

    .note{color:var(--muted);font-size:12px}
    .sep{opacity:.25;margin:0 6px}

    @media(max-width:760px){
      .row > *{flex:1 1 100%}
      .toolbar{align-items:stretch}
      .field{min-width:unset}
      table{min-width:760px}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="wrap">
      <header>
        <div class="row">
          <strong style="font-size:18px">Ceylonese — Admin</strong>
          <span class="pill">Attendance</span>
        </div>
        <div class="row" style="min-width:260px">
          <a href="./" class="ghost" style="padding:10px 12px;border:1px solid var(--border);border-radius:10px">← Staff</a>
          <span id="who" class="muted" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%"></span>
          <button id="btnSignOut" class="ghost">Sign out</button>
        </div>
      </header>
    </div>

    <main class="wrap">
      <!-- Filter toolbar -->
      <section class="card">
        <div class="toolbar">
          <div class="field" style="flex:1 1 160px">
            <label>From</label>
            <input id="fromDate" type="date" />
          </div>
          <div class="field" style="flex:1 1 160px">
            <label>To</label>
            <input id="toDate" type="date" />
          </div>
          <div class="controls fit">
            <button id="btnApply" class="primary">Apply</button>
            <button id="btnExport" class="ghost">Export CSV</button>
          </div>
          <span id="loadMsg" class="muted right"></span>
        </div>

        <div id="approvalsBanner" class="banner hidden">
          Approvals table not found. You can still view/export shifts, but Approve/Reject will fail until you create
          <code>shift_approvals</code> (see comment at the top of this file).
        </div>

        <!-- Shifts table -->
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>When</th>
                <th>User</th>
                <th>Clock In</th>
                <th>Clock Out</th>
                <th>Hours</th>
                <th>Status</th>
                <th class="fit">Actions</th>
              </tr>
            </thead>
            <tbody id="adminBody">
              <tr><td colspan="7" class="muted">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== Supabase init =====
    const SUPABASE_URL = "https://yunrapnjbzyqqzomcqoc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1bnJhcG5qYnp5cXF6b21jcW9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MjkyMTUsImV4cCI6MjA3MjEwNTIxNX0.E_qqD6scsCohrTDOrSZ_TfaLSslXSEb4p5t70UpDT24";
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const fmtDate = (d) => new Date(d).toLocaleDateString();
    const fmtTime = (d) => new Date(d).toLocaleTimeString();
    const toISOStart = (dStr) => new Date(dStr + "T00:00:00").toISOString();
    const toISOEnd   = (dStr) => new Date(dStr + "T23:59:59.999").toISOString();

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function nukeSupabaseStorage(){
      try {
        Object.keys(localStorage).forEach(k => { if (k.startsWith("sb-")) localStorage.removeItem(k); });
        sessionStorage.clear?.();
      } catch (_) {}
    }

    function tryGlobalSignOutNonBlocking(timeoutMs = 1200){
      try {
        const p = supa.auth.signOut({ scope: "global" });
        Promise.race([p, sleep(timeoutMs)]).catch(()=>{});
      } catch (_) {}
    }

    function hardReload(delayMs = 50){
      setTimeout(() => {
        try { window.location.reload(); return; } catch(e){}
        try { window.top.location.reload(); return; } catch(e){}
        try {
          const base = window.location.href.split("#")[0];
          const sep  = base.includes("?") ? "&" : "?";
          window.location.href = `${base}${sep}_r=${Date.now()}`;
          return;
        } catch(e){}
        try { history.go(0); } catch(e){}
      }, delayMs);
    }

    function signOutSafely(){
      try { supa.auth.signOut({ scope: "local" }).catch(()=>{}); } catch(_){}
      nukeSupabaseStorage();
      tryGlobalSignOutNonBlocking();
      requestAnimationFrame(()=>hardReload());
    }

    // ===== Auth guard & role check =====
    async function getProfile(){
      const { data: { user } } = await supa.auth.getUser();
      if (!user) return { user:null, profile:null };
      const { data: profile } = await supa.from("profiles").select("*").eq("id", user.id).maybeSingle();
      return { user, profile };
    }

    function isAdmin(profile){
      // Accept either boolean `is_admin` or string role 'admin'
      return profile?.is_admin === true || String(profile?.role||"").toLowerCase() === "admin";
    }

    // ===== Load & build shifts =====
    let CURRENT_SHIFTS = []; // array of {user_id, user_name, user_email, in, out, hours, note, status}

    async function fetchPunches(fromISO, toISO){
      // prefer punches_view (user info included)
      const { data, error } = await supa
        .from("punches_view")
        .select("created_at, action, note, user_id, full_name, email")
        .gte("created_at", fromISO)
        .lte("created_at", toISO)
        .order("user_id", { ascending: true })
        .order("created_at", { ascending: true });

      if (error) { console.error(error); throw error; }
      return data || [];
    }

    async function fetchApprovals(fromISO, toISO){
      try{
        const { data, error } = await supa
          .from("shift_approvals")
          .select("*")
          .gte("in_time", fromISO)
          .lte("out_time", toISO);
        if (error) throw error;
        return data || [];
      }catch(e){
        // approvals table probably doesn't exist
        $("approvalsBanner").classList.remove("hidden");
        return [];
      }
    }

    function buildShiftsForAll(punchRows, approvals){
      // index approvals by user_id|in|out
      const apprMap = new Map();
      for (const a of approvals){
        const k = `${a.user_id}|${new Date(a.in_time).toISOString()}|${new Date(a.out_time).toISOString()}`;
        apprMap.set(k, a.status);
      }

      // group by user
      const byUser = new Map();
      for (const p of punchRows){
        if (!byUser.has(p.user_id)) byUser.set(p.user_id, []);
        byUser.get(p.user_id).push(p);
      }

      const shifts = [];
      for (const [uid, rows] of byUser){
        let currentIn = null;
        let meta = { name: rows[0]?.full_name || "", email: rows[0]?.email || "" };
        for (const r of rows){
          if (r.action === "in"){
            currentIn = r.created_at;
          } else if (r.action === "out" && currentIn){
            const inT  = currentIn;
            const outT = r.created_at;
            const hours = calcHours(inT, outT);
            const key = `${uid}|${new Date(inT).toISOString()}|${new Date(outT).toISOString()}`;
            const status = apprMap.get(key) || "pending";
            shifts.push({
              user_id: uid,
              user_name: meta.name || meta.email || uid,
              user_email: meta.email,
              in: inT,
              out: outT,
              hours,
              status,
              note: r.note || ""
            });
            currentIn = null;
          }
        }
      }
      return shifts;
    }

    function calcHours(inTime, outTime){
      const diff = new Date(outTime) - new Date(inTime);
      if (diff <= 0) return "0.00";
      return (diff/1000/60/60).toFixed(2);
    }

    function renderShifts(){
      const body = $("adminBody");
      if (!CURRENT_SHIFTS.length){
        body.innerHTML = `<tr><td colspan="7" class="muted">No shifts in this range.</td></tr>`;
        return;
      }
      body.innerHTML = CURRENT_SHIFTS.map((s, i) => `
        <tr data-idx="${i}">
          <td>
            ${fmtDate(s.in)}
            <span class="sep">·</span>
            <span class="note">${new Date(s.in).toLocaleDateString(undefined,{weekday:'short'})}</span>
          </td>
          <td>${escapeHtml(s.user_name)}</td>
          <td>${fmtTime(s.in)}</td>
          <td>${fmtTime(s.out)}</td>
          <td>${s.hours}</td>
          <td>
            <span class="status ${s.status}">
              ${s.status.charAt(0).toUpperCase()+s.status.slice(1)}
            </span>
          </td>
          <td class="fit">
            <div class="controls">
              <button class="approve" data-action="approve" ${s.status==='approved'?'disabled':''}>Approve</button>
              <button class="reject"  data-action="reject"  ${s.status==='rejected'?'disabled':''}>Reject</button>
            </div>
          </td>
        </tr>
        <tr>
          <td colspan="7" class="note">${s.note ? ('Note: ' + escapeHtml(s.note)) : ''}</td>
        </tr>
      `).join("");

      // Wire buttons (event delegation)
      body.onclick = async (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const row = btn.closest("tr[data-idx]");
        if (!row) return;
        const idx = +row.dataset.idx;
        const shift = CURRENT_SHIFTS[idx];
        const action = btn.dataset.action; // 'approve' | 'reject'
        await setApproval(shift, action === "approve" ? "approved" : "rejected");
      };
    }

    function escapeHtml(s){
      return (s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    }

    async function setApproval(shift, status){
      // try get or create approval row without needing unique index
      try{
        const { data: { user: admin } } = await supa.auth.getUser();
        if (!admin) { alert("Not signed in"); return; }

        // Does a record already exist?
        const { data: existing } = await supa
          .from("shift_approvals")
          .select("id")
          .eq("user_id", shift.user_id)
          .eq("in_time", new Date(shift.in).toISOString())
          .eq("out_time", new Date(shift.out).toISOString())
          .limit(1)
          .maybeSingle();

        if (existing && existing.id){
          const { error: upErr } = await supa
            .from("shift_approvals")
            .update({
              status,
              hours: shift.hours,
              approved_by: admin.id,
              approved_at: new Date().toISOString()
            })
            .eq("id", existing.id);
          if (upErr) throw upErr;
        } else {
          const { error: insErr } = await supa
            .from("shift_approvals")
            .insert({
              user_id: shift.user_id,
              in_time: new Date(shift.in).toISOString(),
              out_time: new Date(shift.out).toISOString(),
              hours: shift.hours,
              status,
              approved_by: admin.id,
              approved_at: new Date().toISOString()
            });
          if (insErr) throw insErr;
        }

        // Update UI state locally
        shift.status = status;
        renderShifts();
      }catch(e){
        console.warn(e);
        alert("Approvals feature not available yet. Create the 'shift_approvals' table (see comment at top).");
      }
    }

    function exportCSV(){
      if (!CURRENT_SHIFTS.length){ alert("Nothing to export"); return; }
      const header = ["Date","User","Clock In","Clock Out","Hours","Status","Note"];
      const csv = [header.join(",")].concat(
        CURRENT_SHIFTS.map(s => [
          new Date(s.in).toISOString(),
          `"${(s.user_name||"").replace(/"/g,'""')}"`,
          new Date(s.in).toLocaleTimeString(),
          new Date(s.out).toLocaleTimeString(),
          s.hours,
          s.status.toUpperCase(),
          `"${(s.note||"").replace(/"/g,'""')}"`
        ].join(","))
      ).join("\n");

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "all-shifts.csv"; a.click();
      URL.revokeObjectURL(url);
    }

    // ===== Load range =====
    function setDefaultDates(){
      // default last 30 days
      const today = new Date(); today.setHours(0,0,0,0);
      const dTo = today.toISOString().slice(0,10);
      const from = new Date(today); from.setDate(from.getDate()-30);
      const dFrom = from.toISOString().slice(0,10);
      $("fromDate").value = dFrom;
      $("toDate").value   = dTo;
    }

    async function loadRange(){
      const from = $("fromDate").value;
      const to   = $("toDate").value;
      if (!from || !to){ alert("Please select From and To dates"); return; }

      $("loadMsg").textContent = "Loading…";
      $("approvalsBanner").classList.add("hidden");

      const fromISO = toISOStart(from);
      const toISO   = toISOEnd(to);
      try{
        const [punches, approvals] = await Promise.all([
          fetchPunches(fromISO, toISO),
          fetchApprovals(fromISO, toISO)
        ]);
        CURRENT_SHIFTS = buildShiftsForAll(punches, approvals)
          // only show completed shifts (in/out present)
          .filter(s => s.in && s.out);

        renderShifts();
      }catch(e){
        console.error(e);
        $("adminBody").innerHTML = `<tr><td colspan="7" class="muted">Failed to load shifts.</td></tr>`;
      }finally{
        $("loadMsg").textContent = "";
      }
    }

    // ===== Boot =====
    (async () => {
      // Auth guard
      const ctx = await getProfile();
      if (!ctx.user){
        // not signed in → bounce to staff page (sign-in)
        window.location.replace("./");
        return;
      }
      // Role guard
      if (!isAdmin(ctx.profile)){
        alert("Admin access required");
        window.location.replace("./");
        return;
      }

      // Header who
      $("who").textContent = ctx.profile?.full_name || ctx.user.email || "Admin";

      // Wire controls
      setDefaultDates();
      $("btnApply").onclick = loadRange;
      $("btnExport").onclick = exportCSV;
      $("btnSignOut").onclick = () => {
        $("btnSignOut").disabled = true;
        signOutSafely();
      };

      // Initial load
      await loadRange();

      // Keep session state sane
      supa.auth.onAuthStateChange(async (_ev, session) => {
        if (!session) window.location.replace("./");
      });
    })();
  </script>
</body>
</html>
