<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ceylonese TimeClock</title>

  <!-- Fonts & Supabase -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0f1115; --panel:#151a22; --ink:#e7ebf2; --muted:#94a3b8;
      --gold:#c9a227; --red:#ef4444; --green:#22c55e; --border:#1f2430;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--gold)}
    .wrap{max-width:1000px;margin:0 auto;padding:clamp(16px,3vw,24px)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#0c0f14;border:1px solid var(--border);color:var(--muted);max-width:100%}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 10px 28px rgba(0,0,0,.25)}
    .grid{display:grid;gap:18px}
    @media(min-width:900px){.grid.cols-2{grid-template-columns:1.2fr .8fr}}

    input,button,select{font:inherit}
    input{width:100%;min-width:0;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0c0f14;color:var(--ink)}
    label{display:block;font-weight:600;margin:6px 0}
    button{padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:#0c0f14;color:#fff;cursor:pointer;font-weight:700;min-height:44px}
    button.primary{background:var(--gold);border-color:var(--gold);color:#111}
    button.ghost{background:transparent}
    button.danger{background:transparent;border-color:#3a2020;color:#fecaca}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .center{text-align:center}
    .hidden{display:none}

    .table-scroll{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;max-height:400px;overflow-y:auto}
    table{width:100%;border-collapse:collapse;min-width:560px}
    th,td{padding:10px;border-bottom:1px solid #222b3a;vertical-align:top;word-break:break-word}
    th{text-align:left;color:#cbd5e1;font-weight:700}
    .led{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:8px;background:#475569}
    .led.green{background:var(--green)}
    .led.red{background:#ef4444}

    @media(max-width:600px){
      header strong{font-size:16px}
      .row > *{flex:1 1 100%}
      button, input, select{width:100%}
      .pill{font-size:12px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <strong style="font-size:18px">Ceylonese — TimeClock</strong>
        <span class="pill">Beta</span>
      </div>
      <div class="row" style="min-width:220px">
        <span id="who" class="muted" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%"></span>
        <button id="btnSignOut" class="ghost hidden">Sign out</button>
      </div>
    </header>

    <!-- AUTH (sign-in only) -->
    <section id="authCard" class="card">
      <h2>Sign in</h2>
      <p class="muted">Use your staff email and password.</p>
      <div class="grid" style="grid-template-columns:1fr;gap:12px">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="you@ceylonians.au" autocomplete="email" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnSignIn" class="primary">Sign in</button>
      </div>
      <p id="authMsg" class="muted"></p>
    </section>

    <!-- APP -->
    <section id="app" class="hidden">
      <div class="grid cols-2">
        <!-- STAFF PANEL -->
        <div class="card">
          <div class="row">
            <h2 style="margin:0">My Shifts</h2>
            <span id="statusPill" class="pill right">
              <span id="statusLed" class="led" aria-hidden="true"></span>
              <span id="statusTxt">Not in shift</span>
            </span>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="btnClockIn" class="primary">Clock In</button>
            <button id="btnClockOut" class="danger">Clock Out</button>
            <span class="muted right" id="now" style="white-space:nowrap"></span>
          </div>
          <h3 style="margin-top:16px">Shift Records</h3>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Clock In</th>
                  <th>Clock Out</th>
                  <th>Hours</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="shiftBody"><tr><td colspan="5" class="muted">No shifts yet.</td></tr></tbody>
            </table>
          </div>
        </div>

        <!-- ADMIN PANEL -->
        <div id="adminCard" class="card hidden">
          <div class="row">
            <h2 style="margin:0">Admin — Attendance</h2>
            <button id="btnExport" class="ghost right">Export CSV</button>
          </div>
          <div class="table-scroll">
            <table>
              <thead><tr><th>When</th><th>User</th><th>Action</th><th>Note</th></tr></thead>
              <tbody id="adminBody"><tr><td colspan="4" class="muted">No records yet.</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const SUPABASE_URL = "https://yunrapnjbzyqqzomcqoc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1bnJhcG5qYnp5cXF6b21jcW9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MjkyMTUsImV4cCI6MjA3MjEwNTIxNX0.E_qqD6scsCohrTDOrSZ_TfaLSslXSEb4p5t70UpDT24";

    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);
    const fmtDate = (d) => new Date(d).toLocaleDateString();
    const fmtTime = (d) => new Date(d).toLocaleTimeString();

    const authCard = $("authCard");
    const app = $("app");
    const adminCard = $("adminCard");
    const btnClockIn = $("btnClockIn");
    const btnClockOut = $("btnClockOut");

    function setBusy(msg) { $("authMsg").textContent = msg || ""; }
    function setAuthUI(user, profile){
      if (user) {
        authCard.classList.add("hidden");
        app.classList.remove("hidden");
        $("who").textContent = profile?.full_name
          ? `${profile.full_name} (${profile.is_admin ? "admin" : (profile.role||"staff")})`
          : user.email;
        $("btnSignOut").classList.remove("hidden");
        adminCard.classList.toggle("hidden", !(profile && profile.is_admin));
        loadShifts();
        if (profile && profile.is_admin) loadAdmin();
      } else {
        authCard.classList.remove("hidden");
        app.classList.add("hidden");
        $("btnSignOut").classList.add("hidden");
        $("who").textContent = "";
      }
    }

    async function getProfile(){
      const { data: { user } } = await supa.auth.getUser();
      if (!user) return { user: null, profile: null };
      const { data: profile } = await supa
        .from("profiles")
        .select("id, full_name, role, is_admin")
        .eq("id", user.id)
        .single();
      return { user, profile };
    }

    $("btnSignIn").onclick = async () => {
      setBusy("Signing in…");
      const { error } = await supa.auth.signInWithPassword({
        email: $("email").value.trim(),
        password: $("password").value
      });
      if (error) { setBusy(error.message); return; }
      const ctx = await getProfile();
      setAuthUI(ctx.user, ctx.profile);
      setBusy("");
    };

    $("btnSignOut").onclick = async () => {
      await supa.auth.signOut();
      setAuthUI(null, null);
      authCard.classList.remove("hidden");
      app.classList.add("hidden");
    };

    btnClockIn.onclick  = async () => addPunch("in");
    btnClockOut.onclick = async () => {
      const raw = prompt("Add a note for this shift (optional):", "");
      const note = (raw ?? "").trim();
      await addPunch("out", note || null);
    };

    async function addPunch(action, note){
      const { data: { user } } = await supa.auth.getUser();
      if (!user) { alert("Please sign in"); return; }
      const payload = { user_id: user.id, action };
      if (action === "out" && note) payload.note = note;

      const { error } = await supa.from("punches").insert(payload);
      if (error) { alert(error.message); return; }
      await loadShifts();
    }

    function calculateHours(inTime, outTime){
      if (!inTime || !outTime) return "-";
      const diffMs = new Date(outTime) - new Date(inTime);
      if (diffMs <= 0) return "-";
      const hrs = diffMs/1000/60/60;
      return hrs.toFixed(2);
    }

    async function loadShifts(){
      $("now").textContent = new Date().toLocaleString();
      const { data } = await supa
        .from("punches")
        .select("created_at, action")
        .order("created_at", { ascending: true });

      let shifts = [];
      let currentIn = null;
      for (let p of data){
        if (p.action === "in"){
          currentIn = p.created_at;
        } else if (p.action === "out" && currentIn){
          shifts.push({
            date: fmtDate(currentIn),
            in: fmtTime(currentIn),
            out: fmtTime(p.created_at),
            hours: calculateHours(currentIn, p.created_at),
            status: "Pending"
          });
          currentIn = null;
        }
      }
      if (currentIn){
        shifts.push({
          date: fmtDate(currentIn),
          in: fmtTime(currentIn),
          out: "-",
          hours: "-",
          status: "Pending"
        });
      }

      // live status pill (unchanged logic, minor enhancement)
      const statusTxt = $("statusTxt");
      const statusLed = $("statusLed");
      if (currentIn){
        statusTxt.textContent = "In shift";
        statusLed.classList.add("green");
        statusLed.classList.remove("red");
      } else {
        statusTxt.textContent = "Not in shift";
        statusLed.classList.add("red");
        statusLed.classList.remove("green");
      }

      const body = $("shiftBody");
      body.innerHTML = (shifts && shifts.length)
        ? shifts.map(s => `<tr><td>${s.date}</td><td>${s.in}</td><td>${s.out}</td><td>${s.hours}</td><td>${s.status}</td></tr>`).join("")
        : `<tr><td colspan="5" class="muted">No shifts yet.</td></tr>`;
    }

    async function loadAdmin(){
      const { data } = await supa
        .from("punches_view")
        .select("*")
        .order("created_at", { ascending: false });
      const body = $("adminBody");
      body.innerHTML = (data && data.length)
        ? data.map(r => `<tr>
            <td>${new Date(r.created_at).toLocaleString()}</td>
            <td>${r.full_name || r.email || r.user_id}</td>
            <td>${r.action.toUpperCase()}</td>
            <td>${r.note ? r.note.replace(/</g,'&lt;').replace(/>/g,'&gt;') : ""}</td>
          </tr>`).join("")
        : `<tr><td colspan="4" class="muted">No records yet.</td></tr>`;
      $("btnExport").onclick = () => exportCSV(data || []);
    }

    function exportCSV(rows){
      const header = ["When","User","Action","Note"];
      const csv = [header.join(",")].concat(
        rows.map(r => [
          new Date(r.created_at).toISOString(),
          `"${(r.full_name || r.email || r.user_id).replace(/"/g,'""')}"`,
          r.action,
          `"${(r.note ?? "").replace(/"/g,'""')}"`
        ].join(","))
      ).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "attendance-today.csv"; a.click();
      URL.revokeObjectURL(url);
    }

    (async () => {
      const ctx = await getProfile();
      setAuthUI(ctx.user, ctx.profile);
      supa.auth.onAuthStateChange(async () => {
        const ctx = await getProfile();
        setAuthUI(ctx.user, ctx.profile);
      });
    })();
  </script>
</body>
</html>
