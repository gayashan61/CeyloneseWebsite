<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ceylonese TimeClock</title>

  <!-- Fonts & Supabase -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0f1115; --panel:#151a22; --ink:#e7ebf2; --muted:#94a3b8;
      --gold:#c9a227; --red:#ef4444; --green:#22c55e; --border:#1f2430;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}

    a{color:var(--gold)}
    /* Page layout: header + centered main area */
    .page{min-height:100svh;display:flex;flex-direction:column}
    .wrap{width:100%;max-width:1060px;margin:0 auto;padding:clamp(16px,3vw,24px)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:4px 0 8px}
    main.center{flex:1;display:grid;place-items:center;padding:clamp(8px,2vw,20px)}

    /* Cards & controls */
    .card{width:100%;max-width:720px;margin-inline:auto;background:var(--panel);border:1px solid var(--border);
      border-radius:16px;padding:18px;box-shadow:0 10px 28px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid var(--border);color:var(--muted);max-width:100%}
    .right{margin-left:auto}

    input,button,select,textarea{font:inherit}
    input,textarea{width:100%;min-width:0;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0c0f14;color:var(--ink)}
    textarea{min-height:80px;resize:vertical}
    label{display:block;font-weight:600;margin:6px 0}
    button{padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:#0c0f14;color:#fff;cursor:pointer;font-weight:700;min-height:44px}
    button.primary{background:var(--gold);border-color:var(--gold);color:#111}
    button.ghost{background:transparent}
    button.danger{background:transparent;border-color:#3a2020;color:#fecaca}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .muted{color:var(--muted)}
    .hidden{display:none}

    /* Table area (kept as REAL table on all sizes) */
    .table-scroll{
      position:relative;
      width:100%;
      overflow-x:auto;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;  /* iOS momentum */
      max-height:420px;
      border-radius:12px;
    }
    /* subtle “scrollable” hint on mobile (CSS only) */
    .table-scroll::after{
      content:"Swipe to scroll →";
      position:absolute;
      right:8px; bottom:6px;
      font-size:12px; color:var(--muted);
      pointer-events:none;
      opacity:0; transition:opacity .25s ease;
    }
    @media(max-width:700px){ .table-scroll::after{ opacity:0.9 } }

    table{
      width:100%;
      border-collapse:collapse;
      min-width:640px;          /* forces horizontal scroll on narrow screens */
    }
    th,td{padding:10px;border-bottom:1px solid #222b3a;vertical-align:top;word-break:break-word}
    th{text-align:left;color:#cbd5e1;font-weight:700}
    .table-scroll thead th{
      position: sticky;
      top: 0;
      background: var(--panel);
      z-index: 2;
      box-shadow: 0 2px 0 0 #222b3a;
    }

    /* Clickable shift rows + note row styling */
    tr.shift-row{ cursor: pointer; }
    tr.shift-row:hover{ background:#101521; }
    .note-row td{ background:#0c0f14; color:var(--muted); }

    /* Status LED */
    .led{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:8px;background:#475569}
    .led.green{background:var(--green)}
    .led.red{background:#ef4444}

    /* Modal styles */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center;
      z-index:50;
    }
    .modal-panel{
      width:100%; max-width:520px; background:var(--panel); color:var(--ink);
      border:1px solid var(--border); border-radius:16px; padding:18px;
      box-shadow:0 20px 50px rgba(0,0,0,.45);
    }
    .radio-row{display:flex; gap:16px; align-items:center; flex-wrap:wrap}
    .radio{
      display:flex; align-items:center; gap:8px; padding:10px 12px;
      border:1px solid var(--border); border-radius:12px; background:#0c0f14;
    }

    /* 👇 ensure hidden wins for the modal */
    .modal-backdrop.hidden{ display:none; }

    /* Mobile tweaks */
    @media(max-width:700px){
      header strong{font-size:16px}
      .row > *{flex:1 1 100%}
      button, input, select, textarea{width:100%}
      .pill{font-size:12px}
      th,td{padding:10px 8px}
      table{min-width:560px}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="wrap">
      <header>
        <div class="row">
          <strong style="font-size:18px">Ceylonese — TimeClock</strong>
          <span class="pill">Beta</span>
        </div>
        <div class="row" style="min-width:220px">
          <span id="who" class="muted" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%"></span>
          <button id="btnSignOut" class="ghost hidden">Sign out</button>
        </div>
      </header>
    </div>

    <main class="center">
      <div class="wrap">
        <!-- AUTH (sign-in only) -->
        <section id="authCard" class="card">
          <h2 style="margin-top:0">Sign in</h2>
          <div class="row">
            <div style="flex:1 1 260px; min-width:220px">
              <label>Email</label>
              <input id="email" type="email" placeholder="me@example.com" />
            </div>
            <div style="flex:1 1 200px; min-width:220px">
              <label>Password</label>
              <input id="password" type="password" placeholder="••••••••" />
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <button id="btnSignIn" class="primary">Sign in</button>
            <span id="authMsg" class="muted"></span>
          </div>
        </section>

        <!-- APP (staff only) -->
        <section id="app" class="card hidden">
          <div class="row">
            <h2 style="margin:0">My Shifts</h2>
            <span id="statusPill" class="pill right">
              <span id="statusLed" class="led" aria-hidden="true"></span>
              <span id="statusTxt">Not in shift</span>
            </span>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="btnClockIn" class="primary">Clock In</button>
            <button id="btnClockOut" class="danger">Clock Out</button>
            <span class="muted right" id="now" style="white-space:nowrap"></span>
          </div>

          <h3 style="margin-top:16px">Shift Records</h3>
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Clock In</th>
                  <th>Clock Out</th>
                  <th>Hours</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="shiftBody"><tr><td colspan="5" class="muted">No shifts yet.</td></tr></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- ===== Clock Out Modal (shop + optional note) ===== -->
  <div id="outModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="outTitle">
    <div class="modal-panel">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 id="outTitle" style="margin:0">Clock Out</h3>
        <button id="outClose" class="ghost" aria-label="Close" title="Close">×</button>
      </div>

      <label>Choose shop</label>
      <div class="radio-row" role="radiogroup" aria-label="Shop">
        <label class="radio"><input type="radio" name="shop" id="shopClayton" value="Clayton"> Clayton</label>
        <label class="radio"><input type="radio" name="shop" id="shopBerwic"  value="Berwic"> Berwic</label>
      </div>

      <label style="margin-top:12px">Note (optional)</label>
      <textarea id="outNote" placeholder="Add a note for this shift (optional)"></textarea>

      <div class="row" style="margin-top:14px;justify-content:flex-end">
        <button id="btnOutCancel" class="ghost">Cancel</button>
        <button id="btnOutConfirm" class="primary">Confirm Clock Out</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Supabase init =====
    const SUPABASE_URL = "https://yunrapnjbzyqqzomcqoc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1bnJhcG5qYnp5cXF6b21jcW9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MjkyMTUsImV4cCI6MjA3MjEwNTIxNX0.E_qqD6scsCohrTDOrSZ_TfaLSslXSEb4p5t70UpDT24";
    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Helpers & refs =====
    const $ = (id) => document.getElementById(id);
    const fmtDate = (d) => new Date(d).toLocaleDateString();
    const fmtTime = (d) => new Date(d).toLocaleTimeString();

    const btnClockIn  = $("btnClockIn");
    const btnClockOut = $("btnClockOut");

    async function getProfile(){
      const { data: { user } } = await supa.auth.getUser();
      if (!user) return { user: null, profile: null };
      const { data: profile } = await supa.from("profiles").select("*").eq("id", user.id).maybeSingle();
      return { user, profile };
    }

    function setAuthUI(user, profile){
      const auth = $("authCard");
      const app  = $("app");
      const who  = $("who");
      const signOut = $("btnSignOut");

      if (profile?.is_admin === true || String(profile?.role||"").toLowerCase() === "admin") {
        window.location.href = "admin.html";
      } else {
        if (user){
          who.textContent = (profile && profile.full_name) || user.email || "Signed in";
          auth.classList.add("hidden");
          app.classList.remove("hidden");
          signOut.classList.remove("hidden");
          loadShifts();
        } else {
          who.textContent = "";
          auth.classList.remove("hidden");
          app.classList.add("hidden");
          signOut.classList.add("hidden");
        }
      }
    }

    function showSignInUI(){
      $("authCard").classList.remove("hidden");
      $("app").classList.add("hidden");
      $("btnSignOut").classList.add("hidden");
      $("who").textContent = "";
      if (window.updateButtons) updateButtons(false);
      $("email")?.focus();
    }

    // ===== Auth: Sign in =====
    $("btnSignIn").onclick = async () => {
      const email = $("email").value.trim();
      const password = $("password").value;
      const msg = $("authMsg");
      msg.textContent = "";

      try {
        const { error } = await supa.auth.signInWithPassword({ email, password });
        if (error) { msg.textContent = error.message; return; }

        const { data: { user } } = await supa.auth.getUser();
        if (!user) { msg.textContent = "Sign-in failed: no user session."; return; }

        const { data: profile } = await supa
          .from("profiles")
          .select("*")
          .eq("id", user.id)
          .maybeSingle();

        setAuthUI(user, profile);
      } catch (e) {
        console.error("Sign-in exception:", e);
        msg.textContent = "Sign-in failed. See console for details.";
      }
    };

    ["email","password"].forEach(id =>
      $(id).addEventListener("keydown", e => {
        if (e.key === "Enter") $("btnSignIn").click();
      })
    );

    // ===== Non-blocking sign-out helpers =====
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function nukeSupabaseStorage(){
      try {
        Object.keys(localStorage).forEach(k => { if (k.startsWith("sb-")) localStorage.removeItem(k); });
        sessionStorage.clear?.();
      } catch (_) {}
    }

    function tryGlobalSignOutNonBlocking(timeoutMs = 1200){
      try {
        const p = supa.auth.signOut({ scope: "global" }); // may hang; DO NOT await
        Promise.race([p, sleep(timeoutMs)]).catch(() => {});
      } catch (_) {}
    }

    function hardReload(delayMs = 50){
      setTimeout(() => {
        try { window.location.reload(); return; } catch(e){}
        try { window.top.location.reload(); return; } catch(e){}
        try {
          const base = window.location.href.split("#")[0];
          const sep  = base.includes("?") ? "&" : "?";
          window.location.href = `${base}${sep}_r=${Date.now()}`;
          return;
        } catch(e){}
        try { history.go(0); } catch(e){}
      }, delayMs);
    }

    // IMPORTANT: do NOT await inside this function
    function signOutSafely(){
      try { supa.auth.signOut({ scope: "local" }).catch(() => {}); } catch (_) {}
      nukeSupabaseStorage();
      tryGlobalSignOutNonBlocking();
      try {
        setAuthUI(null, null);
        showSignInUI();
      } catch(_) {}
      requestAnimationFrame(() => hardReload());
    }

    $("btnSignOut").onclick = () => {
      $("btnSignOut").disabled = true;
      signOutSafely();
    };

    // ===== App actions (staff only) =====
    btnClockIn.onclick  = async () => addPunch("in");

    // Open Clock Out modal instead of prompt
    const outModal      = $("outModal");
    const outClose      = $("outClose");
    const outNote       = $("outNote");
    const btnOutCancel  = $("btnOutCancel");
    const btnOutConfirm = $("btnOutConfirm");

    function openOutModal(){
      outModal.classList.remove("hidden");
      outNote.value = "";
      document.getElementById("shopClayton").checked = false;
      document.getElementById("shopBerwic").checked  = false;
      document.getElementById("shopClayton").focus();
    }
    function closeOutModal(){ outModal.classList.add("hidden"); }

    btnClockOut.onclick  = () => openOutModal();
    outClose.onclick     = () => closeOutModal();
    btnOutCancel.onclick = () => closeOutModal();

    // Allow closing by clicking the backdrop
    outModal.addEventListener("click", (e) => {
      if (e.target === outModal) closeOutModal();
    });
    // Close on Esc
    document.addEventListener("keydown", (e) => {
      if (!outModal.classList.contains("hidden") && e.key === "Escape") closeOutModal();
    });

    btnOutConfirm.onclick = async () => {
      const selected = document.querySelector('input[name="shop"]:checked');
      if (!selected){
        alert("Please select a shop (Clayton or Berwic).");
        return;
      }
      const shop = selected.value;
      const note = (outNote.value || "").trim() || null;
      await addPunch("out", note, shop);
      closeOutModal();
    };

    // Insert punch; include shop ONLY for 'out'
    async function addPunch(action, note, shop){
      const { data: { user } } = await supa.auth.getUser();
      if (!user) { alert("Please sign in"); return; }

      const payload = { user_id: user.id, action };
      if (action === "out"){
        if (note) payload.note = note;
        if (shop) payload.shop = shop;  // <-- NEW
      }

      const { error } = await supa.from("punches").insert(payload);
      if (error) { alert(error.message); return; }
      await loadShifts();
    }

    function updateButtons(inShift){
      btnClockIn.disabled = !!inShift;
      btnClockOut.disabled = !inShift;
    }

    function escapeHtml(s){
      return (s??"")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function calculateHours(inTime, outTime){
      if (!inTime || !outTime) return "-";
      const diffMs = new Date(outTime) - new Date(inTime);
      if (diffMs <= 0) return "-";
      const hrs = diffMs/1000/60/60;
      return hrs.toFixed(2);
    }

    async function loadShifts(){
      $("now").textContent = new Date().toLocaleString();
      const { data, error } = await supa
        .from("punches")
        .select("created_at, action, note")   /* shop not required for current table */
        .order("created_at", { ascending: true });

      if (error) { console.error(error); return; }

      let shifts = [];
      let currentIn = null;

      for (let p of (data || [])){
        if (p.action === "in"){
          currentIn = p.created_at;
        } else if (p.action === "out" && currentIn){
          shifts.push({
            date: fmtDate(currentIn),
            in:   fmtTime(currentIn),
            out:  fmtTime(p.created_at),
            hours: calculateHours(currentIn, p.created_at),
            status: "Pending",
            note: p.note || ""
          });
          currentIn = null;
        }
      }
      const inShift = !!currentIn;
      if (inShift){
        shifts.push({
          date: fmtDate(currentIn),
          in:   fmtTime(currentIn),
          out:  "-",
          hours: "-",
          status: "Pending",
          note: ""
        });
      }

      // live status pill
      const statusTxt = $("statusTxt");
      const statusLed = $("statusLed");
      if (inShift){
        statusTxt.textContent = "In shift";
        statusLed.classList.add("green");
        statusLed.classList.remove("red");
      } else {
        statusTxt.textContent = "Not in shift";
        statusLed.classList.add("red");
        statusLed.classList.remove("green");
      }

      // set button states
      updateButtons(inShift);

      // render rows + note toggles
      const body = $("shiftBody");
      if (!shifts.length){
        body.innerHTML = `<tr><td colspan="5" class="muted">No shifts yet.</td></tr>`;
      } else {
        body.innerHTML = shifts.map((s,i)=>`
          <tr class="shift-row" data-idx="${i}" tabindex="0" aria-expanded="false">
            <td>${s.date}</td>
            <td>${s.in}</td>
            <td>${s.out}</td>
            <td>${s.hours}</td>
            <td>${s.status}</td>
          </tr>
          <tr class="note-row hidden" aria-hidden="true">
            <td colspan="5"><strong>Note:</strong> ${s.note ? escapeHtml(s.note) : "<em>None</em>"}</td>
          </tr>
        `).join("");
      }

      body.onclick = (e)=>{
        const row = e.target.closest("tr.shift-row");
        if (!row) return;
        const details = row.nextElementSibling;
        details.classList.toggle("hidden");
        const expanded = !details.classList.contains("hidden");
        row.setAttribute("aria-expanded", String(expanded));
        details.setAttribute("aria-hidden", String(!expanded));
      };
      body.onkeydown = (e)=>{
        if (e.key !== "Enter" && e.key !== " ") return;
        const row = e.target.closest("tr.shift-row");
        if (!row) return;
        e.preventDefault();
        row.click();
      };
    }

    // ===== Boot =====
    (async () => {
      const ctx = await getProfile();
      setAuthUI(ctx.user, ctx.profile);

      // Listener kept as a safety net
      supa.auth.onAuthStateChange(async () => {
        const ctx = await getProfile();
        setAuthUI(ctx.user, ctx.profile);
      });
    })();
  </script>
</body>
</html>
